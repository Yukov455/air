version: '3.8'

services:
  monitoring:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stock-analytics-monitoring
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DATA_UPDATE_INTERVAL=300        # Обновление данных каждые 5 минут
      - MODEL_TRAIN_INTERVAL=3600       # Переобучение модели каждый час
      - AUTO_START_SCHEDULER=true       # Автозапуск планировщика
      - ALPHAVANTAGE_API_KEY=R89IMMWUAE7HUOCY
      - FINNHUB_API_KEY=d5ecdupr01qjckl38rp0d5ecdupr01qjckl38rpg
    volumes:
      - ./data:/app/data                # Персистентное хранение БД
      - ./models:/app/models            # Персистентное хранение моделей
      - ./logs:/app/logs                # Логи
      - ./webapp:/app/webapp            # Веб-интерфейс (для горячего обновления)
      - ./services:/app/services        # Сервисы (для горячего обновления)
      - ./app.py:/app/app.py            # Главный файл (для горячего обновления)
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - stock-network
    labels:
      - "com.stock-analytics.service=monitoring"
      - "com.stock-analytics.description=Data update and model training service"

networks:
  stock-network:
    driver: bridge

volumes:
  monitoring-data:
  monitoring-models:
  monitoring-logs:
